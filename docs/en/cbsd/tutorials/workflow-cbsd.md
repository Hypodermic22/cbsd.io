# Operation with jail

## CREATING JAILS

### commands: jcreate, jconstruct-tui

```
% cbsd jconstruct-tui

% cbsd jcreate jconf=/path/to/conf.jconf
```

***Description***

The jail is created according to configuration file generated by `cbsd jcreate jconf=path_to_cfg`. For create configuration, use a command `cbsd jconstruct` (question-answer dialog mode), or [dialog(1)-based](http://man.freebsd.org/dialog/1)
interface: ***cbsd jconstruct-tui***, or via [WEB interface](https://clonos.tekroutine.com/) . When [pkg.conf](https://wiki.freebsd.org/pkgng) and repository configured properly, you can preset to new jail some packages mark them through ***pkglist*** menu.
For safety reason recommended to use the official FreeBSD ***pkg*** repo or ***build your own*** package repository.

Please note: when repo unavailable, item **pkglist** in ***cbsd jconstruct-tui*** did not show anything.

Please note: multi-repo and and the ability to choose a specific repository from the list at the moment is missing, and will be used repository prescribed in pkg.conf of master host.


```
***Attention!*** Because the list and choose of packages formed by pkg.conf of master machine,
  keep in mind that the content of the selected packages on the list will only work if the architecture and version of the jail equal with master node
```

***Use the features of profiles:***

If you do not use automation (Puppet, Ansible, own implementation for generation of jconf) to create environments and you have to create a container with different parameters, use the ability to create your own [profile](https://www.bsdstore.ru/en/12.0.x/wf_profiles_ssi.html)to override the default values. You can override any parameter - the proposed template for jail name, version, binding to a specific interface instead of 'auto', etc..

for creating config via dialog:

```
% cbsd jconstruct-tui
```

The same menu is available to create a jail when configuring ***CBSD*** via bsdconfig

![](https://www.bsdstore.ru/img/cbsd_syntax3.png)

```
Let it not scare you a small ;-) the number of settings in jconstruct-tui - here are displayed only the most important options, suitable for most people. If you need a more flexible configuration - please use [cbsd jconfig](https://www.bsdstore.ru/en/12.0.x/wf_jconfig_ssi.html)after jail creation

```

If ***jconstruct-tui*** work correctly, on the exit the question for jail create will be asked. In a case positively answer, jcreate it will be executed on a new configuration automatically. Otherwise, the script will save configuration file (in `$workdir/ftmp`), on which it is possible to create a jail by hand.

```
***Important:***

When a new jail is created or obtaining from the repository, make it a rule ALWAYS change the user's password root in jail, even if you do not plan to run it ssh/ftp/rsh and similar services. If the jail is created with applytpl=0, by default /etc/{passwd,master.passwd,group} in the jail as the original "clean" files FreeBSD, so password of root user is empty. If jail created with applytpl=1 (it also refers to images from repository) $workdir/share/jail-skel files will be used as templates where root password is 'cbsd' in default CBSD installation. You can change default root password when new jail is created via edit of hash in skel master.passwd via:

% vipw -d ${workdir}/share/jail-skel/etc

commands, or specify alternative path to jail-skel dir in .jconf (jcreate tools) config

```
You can override the `jailskeldir="$workdir/share/jail-skel"`, parameters which is stored in `$workdir/etc/defaults/jail-freebsd-default.conf` to specify an alternate template directory, which will overwrite the files in the original base files when creating jail. To do this, create a file ***jail-freebsd-XXXXX.conf*** in `$workdir/etc` and enter the value.:

See for details: [Profiles for jail creation](https://www.bsdstore.ru/en/12.0.x/wf_profiles_ssi.html)

## DIALOG MENU OPTIONS


  +  profile - profile in which the parameters are set by default. Described above
  +  pkglist - Select package list for new jail
  +  jname - Short (one word) name of the jail
  +  host_hostname - FQDN for the jail environment
  +  ip4_addr - specify IP addresses (separated by commas if more than one) or 0 for vnet/bhyve environments
  +  ver - FreeBSD version for the base (10.1, 11.0 for RELEASE or 10, 11 for STABLE)
  +  baserw - mount copy of base via nullfs in read only (baserw=no) or populate own copy (baserw=yes) with write access
  +  mount_ports - mount /usr/ports dir from base system to jail (read only). To the environment can build ports (and not interfere with each other vorkdir) - reassigned WRKDIRPREFIX parameters to alternate location. Or, make sure that applytpl params is set to 1 - then CBSD does this automatically via WRKDIRPREFIX=/tmp in /etc/make.conf of the jail
  +  astart - Automatic start jail on the system boot
  +  interface - Specify uplink for jail (on what interface create/remove IP) or prohibit.
  +  applytpl - Automatically adjust the same settings of the jail (create /etc/hosts, change WRKDIRPREFIX, etc..)
  +  floatresolv - Automatically adjust /etc/resolv.conf from jnameserver IP (settings from initenv/initenv-tui)
  +  arch - Specify architecture of jail environment
  +  vnet - Enable or disable VIMAGE feature

![](https://www.bsdstore.ru/gif/jcreate.gif)

### Other methods of creating jail:

#### jcreate command, part 2

```
% cbsd jconstruct

% cbsd jcreate jconf=/path/to/conf.jconf
```
**description:**

If DIALOG-based script jconstruct-tui for some reason did not come for create configuration of the new jails, you can use the script, dialogue like "question and answer" **jconstructi**

```
% cbsd jconstruct
```

Which specifies the same question as the tui-version. Also, the configuration can avoid the formation without additional interactive utilities, for example building systems that automatically create the necessary jails.

Example of a standard configuration for **jcreate** might look like:

```
jname="jail1";
path="/usr/jails/jails/jail1";
host_hostname="jail1.my.domain";
ip4_addr="10.0.0.24/24";
mount_devfs="1";
allow_mount="1";
allow_devfs="0";
allow_nullfs="0";
mount_fstab="/usr/jails/jails-fstab/fstab.jail1";
arch="amd64";
mkhostsfile="1";
devfs_ruleset="4";
ver="10.0";
basename="";
slavenode="0";
baserw="0";
basename="";
mount_src="0";
mount_obj="";
mount_kernel="0";
mount_ports="1";
astart="1";
data="/usr/jails/jails-data/jail1-data";
vnet="0";
applytpl="1";
mdsize="0";
rcconf="/usr/jails/jails-rcconf/rc.conf_jail1";
floatresolv="1";
exec_start="/bin/sh /etc/rc";
exec_stop="/bin/sh /etc/rc.shutdown";

exec_poststart="0";
exec_poststop="0";
exec_prestart="0";
exec_prestop="0";

exec_master_poststart="0";
exec_master_poststop="0";
exec_master_prestart="0";
exec_master_prestop="0";
interface="auto";
jailskeldir="${sharedir}/jail-skel"
```

```
*** Note parameters arch and ver. Values of them may be "i386", "amd64" for arch and "9.2", "10.0", "10.1" "11" and so on, depending on the version of the base, which would you prefer for jail. Values native in these parameters force CBSD always take the version and architecture that is running the node, which makes the floating version. So, if you use a template with arch="native", ver="native" and switch from FreeBSD 10.2 to 11.0, it will use the 11.0 version of the base. If you want to fix a specific version - specify version instead native.
```

If you want to create jail with installed some packages from **pkg** repository, in this configuration must have an **pkglist** pointing to a file with a list of packages, for example:

```
pkglist="/tmp/newjail.txt";
```

The `/tmp/newjail.txt` file might look like:

```
mc
lynx
nginx-devel
lsof
```
**cbsd jcreate** remove file pointed by **pkglist** variables after jail create

```
**Important:**
When a new jail is created or obtaining from the repository, make it a rule ALWAYS change the user's password root in jail, even if you do not plan to run it ssh/ftp/rsh and similar services. If the jail is created with applytpl=0, by default /etc/{passwd,master.passwd,group} in the jail as the original "clean" files FreeBSD, so password of root user is empty. If jail created with applytpl=1 (it also refers to images from repository) $workdir/share/jail-skel files will be used as templates where root password is 'cbsd' in default CBSD installation. You can change default root password when new jail is created via edit of hash in skel master.passwd via:

% vipw -d ${workdir}/share/jail-skel/etc

commands, or specify alternative path to jail-skel dir in .jconf (jcreate tools) config
```



By default, the directory specified by **jailskeldir** will be used as source files that will be added (or they will be overwritten with standard files) into a jail automatically when applytpl=1. Accordingly, you can create any configuration templates and content environments that will be copied when creating a new jail.

##Jail config

### jconfig, jset commands

```
% cbsd jconfig
% cbsd jset
```

**Descriptions:**

Cconfiguration parameters jail

Each **CBSD** jail stores the settings in SQLite3 database. In addition, `$workdir/jails-fstab/` may have fstab files (see below). To change the settings of jail can serve cbsd jconfig command, which is runs the TUI menu to change basic settings:

### Jails IP address

IP addresses that are bound to the jail sets in **ip4_addr** parameter. As an IP may serve as IPv4, and the IPv6 address. When starting and stopping jail, working with IP may take place in two modes:

  * automatic on-the-fly creation of IP addresses for the jail at the time of launch + automatic removal from the interface IP when stopping
  * the use of previously initialized IP addresses.

When for jails assigned to more than one address, they should be listed separated by commas without spaces. IP can include network prefix specified through IP/**prefix**. By default, aliases created with the prefix /32, that may not be appropriate if the jail uses a separate subnet from the network server — in this case, the correct /**prefix** is needed.

The parameter that controls this behavior pointed by **interface** parameter. When **interface=0**, jstart and jstop will not be called ifconfig alias and ifconfig -alias, respectively. If its value is **auto** or name of network nics, this command will be executed:

```
% ifconfig interface ips alias
```

and when jail stop:

```
% ifconfig interface ips -alias
```

Be careful with this option, if you have only one IP for server that is used and this IP is assigned to the same jail, when stopping jail, ip address of the server will be removed automatically that will make the server unavailable. In this case, you need to use:

```
interface=0
```

For example, to run the configuration tool for the jail1, run:

```
% cbsd jconfig jname=jail1
```
###Mounting File Systems in jail

Each jail can have your fstab file, which lists the file systems that are mounted jail is startup. System records (they are managed by **CBSD** and edit this file inappropriately) are located in the file `$workdir/jails-fstab/fstab.name` and the same syntax to format the file system `/etc/fstab` with the exception that as a mount point is the path relative to the root jail, not the master system.

For user entries, you can use the file in the same directory with the extension .local. For example, if you want to make between jail1 and jail2 a shared directory (via nullfs), which physically located in the master node (e.g.: `/usr/home/sharefs`), the files `$workdir/jails-fstab/fstab.jail1.local` and `$workdir/jails-fstab/fstab.jail2.local` should have:

```
/usr/home/sharefs /usr/home/sharefs nullfs rw 0 0
```

If you want to mount tmpfs to `/tmp` dir in jail1 (those actually in `/usr/jails/jails/jail1/tmp`), then the entry in the `$workdir/jails-fstab/fstab.jail1.local` should have:

```
tmpfs /tmp tmpfs rw 0 0
```

If you want to mount into **jail2** a directory from **jail1**, jail1 path should point to the directory containing the data jail1 (and their mount points `${workdir}/jails/jail1`). For example entry `$workdir/jails-fstab/fstab.jail2.local`:

```
/usr/jails/jails-data/jail1-data/usr/local/www /usr/local/www nullfs ro 0 0
```

Make the shared directory /usr/local/www between jail1 and jail2, but it will jail2 in read-only mode

###Presentation of ZFS file systems in jail

If you want to attach separate ZFS filesystems in jail (ie, want to be able to perform in jail zfs mount), ZFS dataset must list in `$workdir/jails-fstab/fstab.$jname.local` file with specifying the keyword zfs in FStype field. For example, if you want to present the file system ZFS: **zroot/jail1_webfs** for jail jail1 `$workdir/jails-fstab/fstab.jail1.local` must have:

```
zroot/jail1_webfs /usr/home/web zfs rw 0 0
```

*Note*: mount point (`/usr/home/web` in this example) is not important

*Note*: jail must have *allow_zfs* paramaters set to 1, what can be done via **cbsd jconfig jname=$jname**

In fact, it makes **CBSD** execute commands:
```
% zfs set jailed=on $FS
% zfs jail $jname $FS
```
when jail started and

```
% zfs set jailed=off $FS
% zfs unjail $jname $FS

```
when stoped.

###Change settings via the jset

Another possibility is to change certain parameters of the jail — use the command **cbsd jset**. Full list of possible arguments can be accessed through --help:

```
% cbsd jget --help
```
For example, to change ip of jail1:

```
% cbsd jset jname=jail1 ip4_addr="10.0.0.20/24,192.168.0.20/24"
```

*cbsd jconfig jname=jail2*

![](https://www.bsdstore.ru/img/jconfig1.png)

*cbsd jset*

![](https://www.bsdstore.ru/img/jconfig2.png)

###Custom scripts for starting and stopping action on jail

You can write your own scripts to be executed within the jail and in the master host on startup and shutdown of the environment. For this, the system directory of jail ( `$workdir/jails-system/$jname/` ) have the following directories:

  * **master_poststart.d** - scripts for executing in the master host after jail starts (*Be careful, because the scripts are is not jailed*)
  * **master_poststop.d** - scripts for executiong in the master host after jail stops (*Be careful, because the scripts are is not jailed*)
  * **master_prestart.d** - scripts for executing in master host before jail starts (*Be careful, because the scripts are is not jailed*)
  * **master_prestop.d** - scripts for execution in master host after jail stops (*Be careful, because the scripts are is not jailed*)
  * **start.d** - scripts for execution within jail when jail is starts. Analog of parameter **exec.start** from original *jail.conf*
  * **stop.d** - scripts for execution within jail when jail is starts. Analog of parameter **exec.stop** from original *jail.conf*
  * **remove.d** - (since CBSD 11.0.10) scripts for execution on remove command

Write scripts to the master_\* directories can be useful if at the start-stop jail you need to perform some action is not associated with content of environment - for example, create a ZFS snapshot, put rules in IPFW and etc.

In scripts, you can use **CBSD** variables, such as **$jname, $path, $data, $ip4_addr**, for example, by placing a script (with execute permission) in `/usr/jails/jails-system/jail1/master_poststart.d/notify.sh`:

```
#!/bin/sh
echo "Jail $jname started with $ip4_addr IP and placed on $path path" | mail -s "$jname started" root@example.net
```

You will receive notification upon startup cells by email: root@example.net

The functionality of execution custom scripts and the availability of variables in environments can play a big role in the integration of **CBSD** and external applications, such as **Consul**

As an example of use, see the article [Example of using CBSD/bhyve and ISC-DHCPD (Serve IP address in bhyve through pre/post hooks)](https://www.bsdstore.ru/en/articles/cbsd_vm_hook_dhcpd.html)

As an example of use, see the article [Example of using CBSD/jail and Consul (Register/unregister jail's via pre/post hooks, in Consul)](https://www.bsdstore.ru/en/articles/cbsd_jail_hook_consul.html)

##Starting and stoping jail

###jstart, jrestart, jorder commands

```
% cbsd jstart jname=jail1 jail2
% cbsd jstart jail1 jail2 ... jailX

% cbsd jstop jname=jail1 jail2
% cbsd jstop jail1 jail2 ... jailX

% cbsd jrestart
% cbsd jorder
```

**Description:**

Running jails occurs at startup **CBSD**/server automatically if parameter **astart** (auto-start) corresponding jail set to 1. You can change this setting through **cbsd jconfig** or cbsd jset. When you stop the server or service **cbsdd**, all running jails will be stopped automatically.

Starting the jail manually by the command:

```
% cbsd jstart jname=jail1
```
or

```
% cbsd jstart jail1
```

or

```
% cbsd jstart jail1 jail2 jail3 ..
```

(to launch multiple jails by one command)

When ( You can change this behavior in cbsd initenv-tui ) **parallel=0** and you try to launch/stoping a few jails, start/stop will be held consecutively. It is not always good, as any error triggered inside jails in the rc-scripts, which leads to a pause, can block start/stop next jails. In the case when **parallel** have a non-zero value, each next jails will be launched/stopped in N seconds after the previous one, where N — **parallel** value. After this timeout, no matter whether the previous jail o start fully and next jail will be started.

To stoping jail **jstop** must be used, with the same syntax and behavior:

```
% cbsd jstop jname=jail1
```
or

```
% cbsd jstop jail1
```

or

```
% cbsd jstop jail1 jail2 jail3 ..
```

(to stopping multiple jails by one command)

If the argument of the jstart/jstop/jrestart command is missing, will displays the corresponding list of all running or stopped jail for interactive selection

When the jail is started, it creates a lock file, a sign that the jail working via file `${jailsysdir}/${jname}/locked` which records the name of the node. This feature is used when this jail presented several nodes, these jail are in the DFS (NFS, glusterfs, etc.) and any node is able to run it. This lock ensures that the presence of the same jail at the second node, it will not be launched.

With a large number of jails (particularly databases, with services such as MySQL, redis, cassandra, etc.), it should be borne in mind that the low value **parallel** (for example, less than 5 seconds) can generate a very intensive storage I/O load that can increase the amount of start-up time of all jails, than if they were run sequentially or higher timeout.

Additionally, when a shutdown command is running on the server with lots of jails/services that should be taken into consideration low timeout that defaults to perform rc.shutdown sequence. In this regard, the process **init(8)** can interrupt the rc-scripts on this timeout, resulting in abnormal shutdown jails. In this case, the database can lead to nonconservation or damage data. To avoid this, `/etc/rc.conf` master system should be adjusted parameter rcshutdown_timeout to a more reasonable value (default: 90 seconds)

In the absence of **rcshutdown_timeout** in the system `/etc/rc.conf`, **cbsd initenv** will put this option in its sole discretion automatically.

Also, keep in mind that when using the zfs features (`$workdir/nc.inventory`, the parameter `zfsfeat=1`), and the file system ZFS, at jstop, file system of jails will be unmounted and those catalog `$workdir/jails-data/jail1-data` will be empty. If in such a case when jail data is requires without running it, by the command zfs list You can see the name appropriate file system and run zfs mount fs.

![](https://www.bsdstore.ru/gif/jstart.gif)


###Writing scripts executed on starting and stopping jail

Please read details on the [Jail config](https://www.bsdstore.ru/en/12.0.x/wf_jconfig_ssi.html#execscript)

###Priority launch of jails

In CBSD you can specify the sequence in which the jails will be started. Please read details on the [jail starting order](https://www.bsdstore.ru/en/12.0.x/wf_jorder_ssi.html)

## Priority launch environments

### Commands: jorder, jorder-tui, border, border-tui

```
% cbsd jls display=jname,b_order
```

**Description**

Sometimes a **jail/vm** will require an already running service from another machine/jail before it is launched. Examples might be a database **SQL** or a running **LDAP**.

In this case, you can edit **Boot Order** (b_order in jail/vm settings)

By default, all environments are created with b_order set to **10** (which is defined in the profile and can be changed)

If you need **jail2** to be launched before **jail1**, its value for *b_order* must be set to a lower one than that of the second jail.

You can display the current configuration with the command **jls**:

```
% cbsd jls display=jname,b_order
JNAME    B_ORDER
firefly  3
jail1    10
kde4     1
kdeold   9
spicy2   2
test     2
```

This sample configuration will launch **kde4** first while **jail1** will come up last

You can also display the sequence using the command **jorder**

```
% cbsd jorder
```

In what sequence jail printer - in this sequence they will run

To edit a launch sequence use **jset** or the TUI-editor **jorder-tuii**

To edit bhyve priority, use the commands **border** or **border-tui**

![](https://www.bsdstore.ru/img/jorder1.png)

![](https://www.bsdstore.ru/img/jorder2.png)

##Jail removal:

###jremove command

```
% cbsd jremove
```

**Description:**

Removal of jail mentions all files anyway connected with a jail:

  a) fstab for current jail
  b) data directory or ZFS filesystem with jail data
  c) statistics and description for jail
  d) snapshots

in a case when **jremove** executed for jail in status On, it will be automatically stopped.
Example:

```
% cbsd jremove jail1
```

![](https://www.bsdstore.ru/img/jremove1.png)

## Jail renaming:

### jrename command

**Description:**

Renames a jail and modifies all relevant according to the new name. The command can only be executed on stopped jails.

jrename has the two following mandatory parameters:

 * **old** — old name of the jail
 * **new** — new name of the jail

Optional parameters:

  * **host_hostname** — FQDN, new full hostname of jail
  * **ip4_addr** — new IP address of the jail (if multiple IPs, separated by a comma with no spaces)

**Example** (renaming jail **jail1** into **jail50** with a FQDN and ip addresses change):

```
% cbsd jrename old=jail1 new=jail50 host_hostname=jail50.my.domain ip4_addr=192.168.0.5/24
```
![](https://www.bsdstore.ru/img/jrename1.png)

##Jail upgrade

###Warning

**Description:**

Upgrade procedure jail always carries certain risks in the form of disruption of service, therefore, make it a rule to always create backups of the jail. If you are running on ZFS file system, you can use the command [cbsd jsnapshot](https://www.bsdstore.ru/en/12.0.x/wf_jsnapshot_ssi.html) for a frozen state of the jail before the start of work. For example:

```
% cbsd jsnapshot mode=create jname=jail1 snapname=before_update
```

and the end of work, if all ok, remove snap through:

```
% cbsd jsnapshot mode=destroy jname=jail1 snapname=before_update
```

If the file system is UFS, you can create an image of the jail through:

```
% cbsd jexport jname=jail1
```

And in the case of success, remove the image jail1.img from `$workdir/export` directory. An upgrade jail **CBSD**, we assume only update files base FreeBSD. Upgrade procedure 3rd-party software in jails similar to upgrade in the non-jail system. You can update the database as between different versions of the system (eg from version 9.2 to FreeBSD 9.3 or FreeBSD 9.3 -> FreeBSD 10.1), and update the files within the same version. It should be remembered that the jails have two modes — baserw=1, when the base part of each jail — have their own copy located in the directory `$workdir/jails-data/$jail`, and **baserw=0**, when one and the same base dir `${workdir}/basejail/base_\*_\*_ver` mounted to all jails.

###jupgrade command

```
% cbsd jupgrade
% cbsd jconfig
```
###Upgrading the basejail

```
% cbsd jset
```
This time, the idea is to set the basejail version of the target jail to that of the desired FreeBSD release. We achieve this by successively: shutting down the jail, setting the appropriate version tag, starting the jail. In case we specified a version for which we don't already have the base, it will be downloaded at jail startup.

```
% cbsd jstop XXX
% cbsd jset jname=XXX ver=11.2
% cbsd jstart XXX
```
###Upgrading via freebsd-update

[freebsd-update](http://man.freebsd.org/freebsd-update/8) can be used without a reference to CBSD. Note that the utility works with the official FreeBSD resource and configure it to the repository CBSD is impossible, those only one source.

Update files for base jail through freebsd-update can via specified key **-b** path to directory which used by CBSD when mounting jail **baserw=0**. For example, if your cbsd `$workdir - /usr/jails`, then for amd64 and version 10.0 is the path to base: `/usr/jails/basejail/base_amd64_amd64_10.0.` This directory should be updated:

```
% freebsd-update -b /usr/jails/basejail/base_amd64_amd64_10.0 fetch
% freebsd-update -b /usr/jails/basejail/base_amd64_amd64_10.0 install
```

If you do not have baserw=1 jail, then its the end. If baserw=1 jails exists, to update them there are two possibilities:

 *  As in the case above, for each jail cause freebsd-update and specify the path to data directory of the jail ( `$workdir/jails-data/$jname` )
 *  Or, after basejail upgrade as described above, execute:

```
cbsd jupgrade jname=XXXX
```

 for each baserw=1 jail - this command reshapes base ( `$workdir/jails-data/$jname` ) of the jail from the `$workdir/basejail/*` files

### Upgrading baserw=0 jails between different versions of the bases via CBSD

Option with the upgrade jail in mode **baserw=0** to a new version base is the easiest is to change the version in the configurator

```
% cbsd jconfig jname=XXX
```
Since in this case only changes the source directory that link on start jail. Example of updating jail from 9.2 to 10.0 version.

Baseline: there x86-64 system with a base of FreeBSD 9.2 and jail jail1 on this base, upgrade to 10.0.

When jail is stopped, we go in the configurator via

```
% cbsd jconfig jname=jail1
```
and change ver parameter to **10.0**, then save it via "Commit". Or, as in the screenshot — do change through **cbsd jset**

On the next run, the jails will mount base 10.0 (on screenshot the base in the system not found and **CBSD** has invited her to download). Of course, with such a upgrade to a new major version, after this operation you need to rebuild the software in the jail or update it through **pkg** — operation is highly desirable because library system changed. As a minimum, to identify this fact we can use the **libchk** utils.

![](https://www.bsdstore.ru/img/jupgrade1.png)
